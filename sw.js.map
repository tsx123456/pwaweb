{"version":3,"sources":["webpack://pwa-promotion-page/./src/utils/sw.js"],"names":["importScripts","precaching","workbox","CACHE_VERSION","Date","now","CACHE_NAME","precacheAndRoute","self","__WB_MANIFEST","cacheId","cleanupOutdatedCaches","skipWaiting","clientsClaim","addEventListener","event","data","json","message","text","title","options","body","icon","badge","url","id","waitUntil","registration","showNotification","notification","close","urlToOpen","eventId","fetch","method","headers","JSON","stringify","catch","clients","matchAll","type","includeUncontrolled","then","windowClients","client","focus","openWindow"],"mappings":"YAIA,cAAc,2EAEd,MAAM,WACL,GACG,QAEE,EAAgB,KAAK,MACrB,EAAa,gBAAgB,IAGnC,EAAW,iBAAiB,u7BAAK,eAAiB,GAAI,CACrD,QAAS,IAGV,EAAW,wBAEX,KAAK,cACL,KAAK,eAGL,KAAK,iBAAiB,OAAQ,IAC7B,IAAI,EAAO,CAAC,EACZ,GAAI,EAAM,KACT,IACC,EAAO,EAAM,KAAK,MACnB,CAAE,MACD,EAAO,CACN,QAAS,EAAM,KAAK,OAEtB,CAGD,MAAM,EAAQ,EAAK,OAAS,UACtB,EAAU,CACf,KAAM,EAAK,SAAW,SACtB,KAAM,EAAK,MAAQ,eACnB,MAAO,EAAK,OAAS,eACrB,KAAM,CACL,IAAK,EAAK,KAAO,IACjB,GAAI,EAAK,IAAM,OAIjB,EAAM,UACL,KAAK,aAAa,iBAAiB,EAAO,MAK5C,KAAK,iBAAiB,oBAAqB,IAC1C,EAAM,aAAa,QACnB,MAAM,EAAY,EAAM,aAAa,KAAK,IAEpC,EAAU,EAAM,aAAa,KAAK,GACpC,GACH,MAAM,qBAAsB,CAC3B,OAAQ,OACR,QAAS,CACR,eAAgB,oBAEjB,KAAM,KAAK,UAAU,CACpB,GAAI,MAEH,MAAM,QAGV,EAAM,UACL,KAAK,QAAQ,SAAS,CACrB,KAAM,SACN,qBAAqB,IAErB,KAAK,IACL,IAAK,MAAM,KAAU,EACpB,GAAI,EAAO,MAAQ,GAAa,UAAW,EAC1C,OAAO,EAAO,QAGhB,GAAI,KAAK,QAAQ,WAChB,OAAO,KAAK,QAAQ,WAAW","file":"sw.js","sourceRoot":"","sourcesContent":["/* eslint-env serviceworker */\n/* global workbox */\r\n\r\n// 引入 Workbox\r\nimportScripts('https://storage.googleapis.com/workbox-cdn/releases/6.5.4/workbox-sw.js');\r\n\r\nconst {\r\n\tprecaching\r\n} = workbox;\r\n\r\nconst CACHE_VERSION = Date.now();\r\nconst CACHE_NAME = `my-app-cache-${CACHE_VERSION}`;\r\n\r\n// 预缓存\r\nprecaching.precacheAndRoute(self.__WB_MANIFEST || [], {\r\n\tcacheId: CACHE_NAME\r\n});\r\n\r\nprecaching.cleanupOutdatedCaches();\r\n\r\nself.skipWaiting();\r\nself.clientsClaim();\r\n\r\n// 推送消息事件\r\nself.addEventListener('push', event => {\r\n\tlet data = {};\r\n\tif (event.data) {\r\n\t\ttry {\r\n\t\t\tdata = event.data.json();\r\n\t\t} catch {\r\n\t\t\tdata = {\r\n\t\t\t\tmessage: event.data.text()\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tconst title = data.title || '你有一条新消息';\r\n\tconst options = {\r\n\t\tbody: data.message || '点击查看详情',\r\n\t\ticon: data.icon || '/192x192.png',\r\n\t\tbadge: data.badge || '/192x192.png',\r\n\t\tdata: {\r\n\t\t\turl: data.url || '/',\r\n\t\t\tid: data.id || null,\r\n\t\t},\r\n\t};\r\n\r\n\tevent.waitUntil(\r\n\t\tself.registration.showNotification(title, options)\r\n\t);\r\n});\r\n\r\n// 通知点击事件\r\nself.addEventListener('notificationclick', event => {\r\n\tevent.notification.close();\r\n\tconst urlToOpen = event.notification.data.url;\r\n\r\n\tconst eventId = event.notification.data.id;\r\n\tif (eventId) {\r\n\t\tfetch('/api/webpush/click', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json'\r\n\t\t\t},\r\n\t\t\tbody: JSON.stringify({\r\n\t\t\t\tid: eventId\r\n\t\t\t})\r\n\t\t}).catch(() => {});\r\n\t}\r\n\r\n\tevent.waitUntil(\r\n\t\tself.clients.matchAll({\r\n\t\t\ttype: 'window',\r\n\t\t\tincludeUncontrolled: true\r\n\t\t})\r\n\t\t.then(windowClients => {\r\n\t\t\tfor (const client of windowClients) {\r\n\t\t\t\tif (client.url === urlToOpen && 'focus' in client) {\r\n\t\t\t\t\treturn client.focus();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (self.clients.openWindow) {\r\n\t\t\t\treturn self.clients.openWindow(urlToOpen);\r\n\t\t\t}\r\n\t\t})\r\n\t);\r\n});"]}